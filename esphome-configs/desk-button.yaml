# M5Stack Atom S3 Lite - Desk Task Button
# Used by life-coach agent to assign tasks and confirm completion
#
# GPIO35: 4x WS2812 RGB LEDs (beneath button)
# GPIO41: Built-in button (active low)
# GPIO4: IR transmitter (unused)
#
# Color states:
#   YELLOW slow pulse = task pending (not priority)
#   RED fast pulse = priority task (do this one!)
#   YELLOW solid = button pressed, processing
#   GREEN flash = acknowledged by agent

esphome:
  name: desk-button
  friendly_name: Desk Button

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  framework:
    type: esp-idf

# Disable serial logging (S3 uses USB CDC)
logger:
  baud_rate: 0

# Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  ap:
    ssid: "Desk-Button"
    password: !secret ap_password

captive_portal:

# Bluetooth proxy for Home Assistant
esp32_ble_tracker:
  scan_parameters:
    active: true

bluetooth_proxy:
  active: true

# RGB LED strip (4 LEDs under button)
light:
  - platform: esp32_rmt_led_strip
    id: led
    name: "LED"
    pin: GPIO35
    num_leds: 4
    chipset: ws2812
    rgb_order: GRB
    effects:
      - pulse:
          name: "Slow Pulse"
          transition_length: 2s
          update_interval: 2s
      - pulse:
          name: "Fast Pulse"
          transition_length: 0.5s
          update_interval: 0.5s
      - strobe:
          name: "Confirm Flash"
          colors:
            - state: true
              brightness: 100%
              red: 0%
              green: 100%
              blue: 0%
              duration: 200ms
            - state: false
              duration: 200ms

# Button with press event
binary_sensor:
  - platform: gpio
    id: button
    name: "Button"
    pin:
      number: GPIO41
      inverted: true
      mode:
        input: true
        pullup: true
    filters:
      - delayed_off: 10ms
    on_press:
      then:
        # If any task was assigned (pending or priority), show yellow solid (processing)
        - if:
            condition:
              or:
                - switch.is_on: task_pending
                - switch.is_on: task_priority
            then:
              # Yellow solid = button pushed, waiting for agent to process
              - light.turn_on:
                  id: led
                  brightness: 100%
                  red: 100%
                  green: 70%
                  blue: 0%
                  effect: none
              - switch.turn_off: task_pending
              - switch.turn_off: task_priority

# Text sensor for current task (set by Home Assistant)
text_sensor:
  - platform: template
    id: current_task
    name: "Current Task"

# Task pending switch - YELLOW slow pulse = task waiting (not priority)
switch:
  - platform: template
    id: task_pending
    name: "Task Pending"
    optimistic: true
    on_turn_on:
      # Only show yellow if not already priority (priority takes precedence)
      - if:
          condition:
            switch.is_off: task_priority
          then:
            - light.turn_on:
                id: led
                brightness: 50%
                red: 100%
                green: 70%
                blue: 0%
                effect: "Slow Pulse"
    on_turn_off:
      # LED stays yellow solid (set by button press) until acknowledged
      - lambda: |-
          // Do nothing - let acknowledged switch or priority handle LED

  # Task priority switch - RED fast pulse = do this one next!
  - platform: template
    id: task_priority
    name: "Task Priority"
    optimistic: true
    on_turn_on:
      # RED fast pulse - this is the priority task
      - light.turn_on:
          id: led
          brightness: 80%
          red: 100%
          green: 0%
          blue: 0%
          effect: "Fast Pulse"
    on_turn_off:
      # If still pending, go back to yellow slow pulse
      - if:
          condition:
            switch.is_on: task_pending
          then:
            - light.turn_on:
                id: led
                brightness: 50%
                red: 100%
                green: 70%
                blue: 0%
                effect: "Slow Pulse"

  # Acknowledged switch - GREEN flash = agent received it
  - platform: template
    id: task_acknowledged
    name: "Task Acknowledged"
    optimistic: true
    on_turn_on:
      # GREEN flash = acknowledged by agent
      - light.turn_on:
          id: led
          brightness: 100%
          red: 0%
          green: 100%
          blue: 0%
          effect: "Confirm Flash"
      - delay: 2s
      - light.turn_off: led
      - switch.turn_off: task_acknowledged
